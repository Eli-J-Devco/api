<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Reports">
	<resultMap id="ReportsMap" type="com.nwm.api.entities.ReportsEntity">
		<result property="id" column="id" />
		<result property="id_site" column="id_site" />
		<result property="id_employee" column="id_employee" />
		<result property="report_type" column="report_type" />
		<result property="cadence_range" column="cadence_range" />
		<result property="date_from" column="date_from" />
		<result property="date_to" column="date_to" />
		<result property="subscribers" column="subscribers" />
		<result property="data_intervals" column="data_intervals" />
		<result property="file_type" column="file_type" />
		<result property="status" column="status" />
		<result property="created_date" column="created_date" />
		<result property="created_by" column="created_by" />
		<result property="updated_date" column="updated_date" />
		<result property="updated_by" column="updated_by" />
	</resultMap>
	
	<select id="getListSiteByEmployee" resultType="Map">
		SELECT
			s.id,
			s.id AS value,
			s.`name` AS text,
			s.`name` AS label
		FROM
			site AS s
		WHERE
			 s.is_delete = 0 AND s.`status` = 1
			 <if test="id_sites != null">
				AND s.id IN  (
					<foreach item="item" index="index" collection="id_sites" separator=" , ">
						#{item.id}
					</foreach>
				)
			</if>
		ORDER BY s.`name` ASC
	</select>
	
	<select id="getListSiteByIdEmployee" resultType="Map">
		SELECT
			s.id,
			s.`name`
		FROM
			site_employee_map sem
			LEFT JOIN site s ON s.id = sem.id_site
		WHERE
			s.is_delete = 0
			AND s.`status` = 1
			AND sem.id_employee = #{id_employee}
	</select>
	
	<select id="getListSiteSubGroupByEmployee" resultType="Map" >
		SELECT
			ssg.id,
			ssg.id_site_group,
			ssg.`name` AS text
		FROM
			site s
			LEFT JOIN site_sub_group ssg ON ssg.id = s.id_site_sub_group
			LEFT JOIN site_group sg ON sg.id = ssg.id_site_group
		WHERE 
			ssg.status = 1
			AND ssg.is_delete = 0
			AND sg.status = 1
			AND sg.is_delete = 0
			<if test="id_sites != null">
				AND s.id IN  (
					<foreach item="item" index="index" collection="id_sites" separator=" , ">
						#{item.id}
					</foreach>
				)
			</if>
		GROUP BY ssg.id
	    ORDER BY ssg.id ASC
	</select>
	
	<select id="getListSiteBySubGroup" resultType="Map" >
		SELECT
			s.id,
			s.`name`
		FROM
			site s
			LEFT JOIN site_sub_group ssg ON ssg.id = s.id_site_sub_group
			LEFT JOIN site_group sg ON sg.id = ssg.id_site_group
		WHERE 
			s.`status` = 1
			AND s.is_delete = 0
			AND ssg.status = 1
			AND ssg.is_delete = 0
			AND sg.status = 1
			AND sg.is_delete = 0
			AND s.id_site_sub_group = #{id_sub_group}
	</select>
	
	<select id="getListSelectedSiteByIdSite" resultType="Map" >
		SELECT
			s.id,
			s.`name`
		FROM
			site s
		WHERE 
			s.`status` = 1
			AND s.is_delete = 0
			AND s.id IN (${ids_site})
	</select>
	
	<insert id="insertReports" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `report`(
			`id_site`,
			`id_employee`,
			`type_report`,
			`cadence_range`,
			`date_from`,
			`date_to`,
			`subscribers`,
			`data_intervals`,
			`file_type`,
			`status`,
			`created_date`,
			`updated_date`,
			`id_sub_group`,
			`type_option`,
			`schedule_enable`,
			`periodicity`,
			`time_schedule`,
			`days_week`,
			`offset_timezone`
		)VALUES(
			#{id_site},
			#{id_employee},
			#{type_report},
			#{cadence_range},
			#{date_from},
			#{date_to},
			#{subscribers},
			#{data_intervals},
			#{file_type},
			#{status},
			NOW(),
			NOW(),
			#{id_sub_group},
			#{type_option},
			#{schedule_enable},
			#{periodicity},
			#{time_schedule},
			#{days_week},
			#{offset_timezone}
		);
		<selectKey keyProperty="id" resultType="int">
	        SELECT 
	        LAST_INSERT_ID() as id
        </selectKey>
	</insert>
	
	<update id="updateReports">
		UPDATE `report`
		SET
			`id_site` = #{id_site},
			`id_employee` = #{id_employee},
			`type_report` = #{type_report},
			`cadence_range` = #{cadence_range},
			`date_from` = #{date_from},
			`date_to` = #{date_to},
			`subscribers` = #{subscribers},
			`data_intervals` = #{data_intervals},
			`file_type` = #{file_type},
			`status` = #{status},
			`updated_date` = NOW(),
			`id_sub_group` = #{id_sub_group},
			`type_option` = #{type_option},
			`schedule_enable` = #{schedule_enable},
			`periodicity` = #{periodicity},
			`time_schedule` = #{time_schedule},
			`days_week` = #{days_week},
			`offset_timezone` = #{offset_timezone},
			`next_run_time` = NULL
		WHERE
			`id` = #{id}
	</update>
	
	
	<select id="getList" resultType="Map" >
		SELECT
			s.`name` AS site_name,
			CASE
		    	WHEN r.type_report = 1 THEN CONCAT_WS( " " , s.`name`, "Solar Production Report") 
		    	WHEN r.type_report = 3 THEN CONCAT_WS( " " , s.`name`, "Leviton BMO Consumption Report") 
		    	WHEN r.type_report = 4 THEN CONCAT_WS( " " , s.`name`, "Asset Management and Operation Performance Report") 
		    	WHEN r.type_report = 2 THEN
		    		CASE
		    			WHEN r.type_option = 1 THEN CONCAT_WS( " " , "Entire Portfolio", "Production Trend Report")
		    			WHEN r.type_option = 2 THEN CONCAT_WS( " " , t.sites_name, "Production Trend Report")
		    			WHEN r.type_option = 3 THEN CONCAT_WS( " " , ssg.name, "Sub-Group", "Production Trend Report")
		    		END
		    	ELSE s.`name`
			END	AS report_name,
			
			CASE
		    	WHEN r.cadence_range = 1 THEN "Daily"
				WHEN r.cadence_range = 2 THEN "Monthly"
				WHEN r.cadence_range = 3 THEN "Quarterly"
				WHEN r.cadence_range = 4 THEN "Annual"
				WHEN r.cadence_range = 6 THEN "Weekly"
		    	ELSE "Custom"
			END	AS cadence_range_name,
			
			
			CASE
		    WHEN r.data_intervals = 1 THEN "5 Minutes"
				WHEN r.data_intervals = 2 THEN "15 Minutes"
				WHEN r.data_intervals = 3 THEN "1 Hour"
		    ELSE ""
			END	AS data_intervals_name,
			
			CASE
		    WHEN r.file_type = 1 THEN "PDF"
				WHEN r.file_type = 2 THEN "Excel"
				WHEN r.file_type = 3 THEN "CSV"
		    ELSE ""
			END	AS file_type_name,
		
			r.id,
			s.id AS id_site,
			s.table_data_report,
			r.id_employee,
			r.cadence_range,
			r.type_report,
			r.data_intervals,
			r.subscribers,
			r.file_type,
			r.type_option,
			r.id_sub_group,
			DATE_FORMAT(r.date_from, '%Y-%m-%d %H:%i:%s') AS date_from,
			DATE_FORMAT(r.date_to, '%Y-%m-%d %H:%i:%s') AS date_to,
			r.`status`,
			r.schedule_enable,
			DATE_FORMAT(r.time_schedule, '%Y-%m-%d %H:%i') AS time_schedule,
			r.periodicity,
			r.days_week,
			DATE_FORMAT(r.created_date, '%m/%d/%Y %H:%i %p') AS created_on,
			DATE_FORMAT(r.updated_date, '%m/%d/%Y %H:%i %p') AS last_modified,
			CASE
					WHEN r.type_report = 2 AND r.type_option = 1 THEN (
						SELECT GROUP_CONCAT(s.id SEPARATOR ',') AS ids_site
								FROM site_employee_map sem 
								LEFT JOIN site s ON s.id = sem.id_site
							WHERE sem.id_employee = r.id_employee AND s.`status` = 1 AND s.is_delete = 0
					)
					
					WHEN r.type_report = 2 AND r.type_option = 2 THEN (
						SELECT
							GROUP_CONCAT(s.id SEPARATOR ',')
						FROM
							report_site_map rsm
							LEFT JOIN site s ON s.id = rsm.id_site
							WHERE s.`status` = 1 AND s.is_delete = 0 AND rsm.id_report = r.id
						GROUP BY rsm.id_report
					)
					WHEN r.type_report = 2 AND r.type_option = 3 THEN (
						SELECT GROUP_CONCAT(s.id SEPARATOR ',')
						FROM site s WHERE 
						s.`status` = 1 AND s.is_delete = 0 AND s.id_site_sub_group = r.id_sub_group
					)
					ELSE t.ids_site
			END AS ids_site
		FROM
			report r
			LEFT JOIN site s ON s.id = r.id_site
			LEFT JOIN site_sub_group ssg ON ssg.id = r.id_sub_group
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			LEFT JOIN (
				SELECT
					rsm.id_report,
					GROUP_CONCAT(s.name SEPARATOR ' - ') AS sites_name,
					GROUP_CONCAT(s.id SEPARATOR ', ') AS ids_site
				FROM
					report_site_map rsm
					LEFT JOIN site s ON s.id = rsm.id_site
				GROUP BY rsm.id_report
			) t ON t.id_report = r.id
		WHERE r.status = 1 
		AND (CONVERT_TZ(NOW(), '+00:00', t.offset) <![CDATA[ < ]]> s.expiration OR s.expiration IS NULL)
		
		<if test="is_supper_admin != 1">
			AND r.id_employee = #{id_employee} 
		</if>
			
		GROUP BY r.id 
		    order by
	        <choose>  
	            <when test="sort_column == 'id'">
	                r.id ${order_by}
	            </when>         
	            <when test="sort_column == 'name'">
	                r.name ${order_by}
	            </when>
	            
	            <otherwise>
			      r.id DESC
			    </otherwise>                                                  
	        </choose>  
		 	 
		 LIMIT ${limit} OFFSET ${offset};
	</select>
	
  	
	
	<select id="getListCount"  resultType="int" parameterType="com.nwm.api.entities.ReportsEntity">
    	SELECT count(*) as totalRow
		FROM report r
		WHERE r.status = 1
		<if test="is_supper_admin != 1">
			AND r.id_employee = #{id_employee}
		</if>
		
		
  	</select>
  	
  	
  	
  	<delete id="deleteReports">
		DELETE FROM `report`
		WHERE id = #{id}
	</delete>
	
	
	
	<select id="getSiteDetail" resultType="com.nwm.api.entities.ViewReportEntity" parameterType="com.nwm.api.entities.ViewReportEntity" >
		SELECT
			s.id,
			s.id AS id_site,
			s.`name` AS site_name,
			DATE_FORMAT(NOW(), '%m/%d/%Y') AS report_date,
			s.ac_capacity,
			s.dc_capacity,
			"Normal" AS system_status
		FROM
			site s 
		WHERE
			s.id = #{id_site}
	</select>
	
	
	<select id="getDetailReport" resultType="com.nwm.api.entities.ViewReportEntity" parameterType="com.nwm.api.entities.ViewReportEntity" >
		SELECT
			r.id,
			s.id AS id_site,
			s.`name` AS site_name,
			s.table_data_report,
			s.table_data_virtual,
			DATE_FORMAT(NOW(), '%m/%d/%Y') AS report_date,
			s.ac_capacity,
			s.dc_capacity,
			"Normal" AS system_status,
			r.cadence_range,
			r.subscribers,
			r.data_intervals,
			r.type_report,
			r.type_option,
			r.id_sub_group,
			r.id_employee,
			t.ids_site,
			CASE
		    	WHEN r.type_report = 1 THEN CONCAT_WS( " " , s.`name`, "Solar Production Report") 
		    	WHEN r.type_report = 3 THEN CONCAT_WS( " " , s.`name`, "Leviton BMO Consumption Report") 
		    	WHEN r.type_report = 4 THEN CONCAT_WS( " " , s.`name`, "Asset Management and Operation Performance Report") 
		    	WHEN r.type_report = 2 THEN
		    		CASE
		    			WHEN r.type_option = 1 THEN CONCAT_WS( " " , "Entire Portfolio", "Built-in Report")
		    			WHEN r.type_option = 2 THEN CONCAT_WS( " " , t.sites_name, "Built-in Report")
		    			WHEN r.type_option = 3 THEN CONCAT_WS( " " , ssg.name, "Sub-Group", "Built-in Report")
		    		END
		    	ELSE s.`name`
			END	AS report_name,
			CONCAT_WS(', ', s.number, s.street, s.city, s.state, s.postal_code ) AS address,
			IF(v.enable_virtual_device > 0 , 1, 0) AS enable_virtual_device
		FROM
			site s 
			LEFT JOIN report r ON r.id_site = s.id
			LEFT JOIN site_sub_group ssg ON ssg.id = r.id_sub_group
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			LEFT JOIN (
				SELECT
					rsm.id_report,
					GROUP_CONCAT(s.name SEPARATOR ' - ') AS sites_name,
					GROUP_CONCAT(s.id SEPARATOR ', ') AS ids_site
				FROM
					report_site_map rsm
					LEFT JOIN site s ON s.id = rsm.id_site
				GROUP BY rsm.id_report
			) t ON t.id_report = r.id
			LEFT JOIN (
				SELECT
					COUNT(*) AS enable_virtual_device,
					d.id_site
				FROM
					device d 
				WHERE
					d.`status` = 1 
					AND d.is_delete = 0 
					AND d.hidden = 0
					AND d.virtual_device_type IS NOT NULL
					AND d.virtual_device_type != ''
					AND d.id_site = #{id_site}
			) v ON v.id_site = s.id
		WHERE
			r.id = #{id}
			AND (CONVERT_TZ(NOW(), '+00:00', t.offset) <![CDATA[ < ]]> s.expiration OR s.expiration IS NULL)
	</select>
  	
  	
  	
  	<select id="getReportYearDataEnergy" resultType="Map" >
		SELECT 
			t.convert_time,
			SUM(t.tmp_energy) AS sumEergy,
			t.year,
			t.month
		FROM (
			SELECT
				iv.time,
				si.id,
				<if test="table_name = 'model_shark100'">
					MAX(iv.w_hours_received) - MIN(iv.w_hours_received) AS tmp_energy,
				</if>
				DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%Y-%m' ) AS local_time,
				DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%b. %y' ) AS convert_time,
				DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%Y' ) AS year,
				LOWER( DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%b' ) )  AS month
				
				
			FROM
				site si
				LEFT JOIN time_zone t ON t.id = si.id_time_zone
				LEFT JOIN device d ON d.id_site = si.id
				LEFT JOIN ${table_name} iv ON iv.id_device = d.id 
			WHERE
				si.id = #{id_site}
				AND si.`status` = 1
				AND si.is_delete = 0 
				AND iv.error = 0
				AND (CONVERT_TZ( iv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
				GROUP BY local_time, d.id
		)t GROUP BY t.convert_time ORDER BY t.time
	</select>
	
	
	<select id="getReportEnergyExpectations" resultType="Map" >
		SELECT
			* 
		FROM
			energy_expectations ee 
		WHERE
			ee.id_site = #{id_site}
	</select>
	
	
	<select id="getListDeviceTypeMeter" resultType="Map">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
		WHERE
			dt.id = 3 
			AND d.id_site = #{id_site}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getListDeviceTypeInverter" resultType="Map">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
		WHERE
			dt.id = 1
			AND d.id_site = #{id_site}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getDataEnergyMonthlyReport" resultType="Map" >
		SELECT
			s.id,
			s.id AS id_site,
			s.`name`,
			DATE_FORMAT( sdr.time, '%m' ) AS month,
			DATE_FORMAT( sdr.time, '%Y' ) AS year,
			DATE_FORMAT( sdr.time, '%m/%d/%Y' ) AS categories_time,
			DATE_FORMAT( sdr.time, '%m/%d/%Y' ) AS time_full,
			DATE_FORMAT( sdr.time, '%Y-%m-%d' ) AS time_format,
			
			IF( (SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0))) > 0, (ROUND(SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)), 1)), ROUND(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)), 1) ) AS chart_energy_kwh,
			IFNULL(SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)), 0.001) AS meterEnergy,
			IFNULL(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)), 0.001) AS inverterEnergy
			
		FROM
			${table_data_report} sdr 
			LEFT JOIN device d ON d.id = sdr.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			
		WHERE
			s.`status` = 1
			AND d.`status` = 1
			AND s.is_delete = 0
			AND d.is_delete = 0
			AND s.id = #{id_site}
			AND (sdr.time BETWEEN #{start_date} AND #{end_date})
			GROUP BY s.id, DATE_FORMAT( sdr.time , "%Y-%m/%d")
	</select>
	
	<select id="getListSiteREC" resultType="Map" >
		SELECT
			s.id,
			s.name,
			s.id AS id_site,
			IF(s.rec_id IS NULL || s.rec_id = '', CONCAT_WS("-", "NWM", s.id), s.rec_id) AS rec_id,
			IF(s.gu_id IS NULL || s.gu_id = '', CONCAT_WS("-", "NWM", s.id), s.gu_id) AS gu_id,
			IFNULL(ROUND(SUM( d.energy_this_month ) / 1000, 1), 0 ) AS energy_this_month,
			DATE_FORMAT( #{start_date}, "%m/%d/%Y") AS start_date,
			DATE_FORMAT(#{end_date}, "%m/%d/%Y") AS end_date,
			DATE_FORMAT(#{end_date}, "%m/%Y") AS vintage_date
		FROM
			site s
			LEFT JOIN device d ON d.id_site = s.id 
		WHERE
			s.`status` = 1 
			AND d.`status` = 1 
			<if test="id_sites != null">
				AND s.id IN  (
					<foreach item="item" index="index" collection="id_sites" separator=" , ">
						#{item.id}
					</foreach>
				)
			</if>
		GROUP BY
			s.id
	</select>
	
	
	
	<select id="getDataEnergyRECReport" resultType="Map" >
		<foreach item="item" index="index" collection="id_sites" separator="UNION">
		SELECT
			d.id,
			s.`name`,
			d.devicename,
			IF(d.ru_id IS NULL || d.ru_id = '', CONCAT_WS("-", "NWM", d.id), d.ru_id) AS ru_id,
			IF(d.gu_id IS NULL || d.gu_id = '', CONCAT_WS("-", "NWM", d.id), d.gu_id) AS gu_id,
			DATE_FORMAT(#{start_date}, "%m/%d/%Y") AS start_date,
			DATE_FORMAT(#{end_date}, "%m/%d/%Y") AS end_date,
			DATE_FORMAT(#{end_date}, "%m/%Y") AS vintage_date,
			0 AS is_edit,
			CASE
			    WHEN DATE_FORMAT( sdr.time, '%m/%Y' ) != DATE_FORMAT(CONVERT_TZ(NOW(),'+00:00', t.`offset`), '%m/%Y') THEN FORMAT(SUM(sdr.ActualGeneration) / 1000 * 0.97, 2) 
			    ELSE 0
			END AS energy_this_month
			
		FROM
			${item.table_data_report} sdr 
			LEFT JOIN device d ON d.id = sdr.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			
		WHERE
			s.`status` = 1
			AND s.is_delete = 0
			AND d.`status` = 1
			AND d.is_delete = 0
			AND d.id = #{item.value}
			AND d.id_device_type = 3
			AND d.consumption_meter = 0
			AND DATE_FORMAT(sdr.time, '%Y-%m') = DATE_FORMAT( #{end_date}, '%Y-%m')
			AND s.is_rec_report = 1
			AND s.reporting_region = #{reporting_region}
		GROUP BY
			d.id
		</foreach>
		
		
	</select>
	
	
	
	<update id="updateRECID">
		UPDATE `device`
		SET
			`ru_id` = #{ru_id}
		WHERE
			`id` = #{id}
	</update>
	
	
	<update id="updateGUID">
		UPDATE `device`
		SET
			`gu_id` = #{gu_id}
		WHERE
			`id` = #{id}
	</update>
	
	
	
	
	<select id="getDataEnergyQurterlyReport" resultType="Map" >
		SELECT
			s.id,
			s.id AS id_site,
			s.`name`,
			DATE_FORMAT( sdr.time, '%b-%Y' ) AS categories_time,
			DATE_FORMAT( sdr.time, '%m/%d/%Y' ) AS categories_time_by_day,
			DATE_FORMAT( sdr.time, '%m-%Y' ) AS time_full,
			DATE_FORMAT( sdr.time, '%Y-%m' ) AS time_format,
			DATE_FORMAT( sdr.time, '%Y-%m-%d' ) AS time_format_by_day,
			IF( (SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0))) > 0, (ROUND(SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)), 1)), ROUND(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)), 1) ) AS chart_energy_kwh,
			IFNULL(SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)), 0.001) AS meterEnergy,
			IFNULL(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)), 0.001) AS inverterEnergy
			
		FROM
			${table_data_report} sdr 
			LEFT JOIN device d ON d.id = sdr.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			
		WHERE
			s.`status` = 1
			AND d.`status` = 1
			AND s.is_delete = 0
			AND d.is_delete = 0
			AND s.id = #{id_site}
			AND (sdr.time BETWEEN #{start_date} AND #{end_date})
			GROUP BY s.id,
			<choose>
				<when test="data_intervals == 4">
					time_format_by_day
				</when>
				<when test="data_intervals == 6">
					time_format
				</when>
				<otherwise>
					time_format
				</otherwise>
			</choose>
		
	</select>
	
	<select id="getDataInverterAvailabilityByDay" resultType="Map" >
		SELECT
			ROUND(AVG(sdr.InverterAvailability) * 100, 2) AS InverterAvailability,
			DATE_FORMAT( sdr.time, '%m/%d/%Y' ) AS categories_time,
			DATE_FORMAT( sdr.time, '%Y-%m-%d' ) AS time_format
		FROM
			${table_data_report} sdr
			LEFT JOIN device d ON d.id = sdr.id_device
		WHERE
			d.`status` = 1
			AND d.is_delete = 0
			AND d.id_device_type = 1
			AND d.id_site = #{id_site}
			AND (sdr.time BETWEEN #{start_date} AND #{end_date})
		GROUP BY time_format
	</select>
	
	<select id="getDataWeatherStationByDay" resultType="Map" >
		SELECT
			sdr.POAAVG,
			sdr.TCellAVG,
			DATE_FORMAT( sdr.time, '%m/%d/%Y' ) AS categories_time,
			DATE_FORMAT( sdr.time, '%Y-%m-%d' ) AS time_format
		FROM
			${table_data_report} sdr
			LEFT JOIN device d ON d.id = sdr.id_device
		WHERE
			d.`status` = 1
			AND d.is_delete = 0
			AND d.id_device_type = 4
			AND d.id_site = #{id_site}
			AND (sdr.time BETWEEN #{start_date} AND #{end_date})
	</select>
	
	
	<select id="getDataEnergyAnnuallyReport" resultType="Map" >
		SELECT
			s.id,
			s.id AS id_site,
			s.`name`,
			DATE_FORMAT( sdr.time, '%b-%Y' ) AS categories_time,
			DATE_FORMAT( sdr.time, '%m-%Y' ) AS time_full,
			DATE_FORMAT( sdr.time, '%Y-%m' ) AS time_format,
			DATE_FORMAT( sdr.time, '%Y' ) AS year,
			DATE_FORMAT( sdr.time, '%m' ) AS month_number,
			DATE_FORMAT( sdr.time, '%b' ) AS month,
			IF( (SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0))) > 0, (ROUND(SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)), 1)), ROUND(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)), 1) ) AS chart_energy_kwh,
			IFNULL(SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)), 0.001) AS meterEnergy,
			IFNULL(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)), 0.001) AS inverterEnergy
			
		FROM
			${table_data_report} sdr 
			LEFT JOIN device d ON d.id = sdr.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			
		WHERE
			s.`status` = 1
			AND d.`status` = 1
			AND s.is_delete = 0
			AND d.is_delete = 0
			AND s.id = #{id_site}
			AND (sdr.time BETWEEN #{start_date} AND #{end_date})
			GROUP BY s.id, DATE_FORMAT( sdr.time , "%Y-%m")
			
		
	</select>
	
	
	<select id="getInverterAvailability" resultType="Map" >
		SELECT 
			ROUND((SUM(t.InverterAvailability)/ DATE_FORMAT(LAST_DAY(t.time),'%d') ), 1) AS InverterAvailability,
			t.time_full
			FROM (
			SELECT
				sd.time,
				ROUND(AVG(sd.InverterAvailability) * 100, 2) AS InverterAvailability,
				DATE_FORMAT( sd.time, '%b-%Y') AS time_full
			FROM
				${table_data_report} sd
				LEFT JOIN device d ON d.id = sd.id_device 
			WHERE
				d.id_site = #{id_site}
				AND d.id_device_type = 1
				AND (sd.time BETWEEN #{start_date} AND #{end_date})
				GROUP BY sd.time
		)t
		GROUP BY t.time_full
	</select>
	
	<select id="getMeterAvailability" resultType="Map" >
		SELECT 
			ROUND((SUM(t.InverterAvailability)/ DATE_FORMAT(LAST_DAY(t.time),'%d') ), 1) AS InverterAvailability,
			t.time_full
			FROM (
			SELECT
				sd.time,
				ROUND(AVG(sd.InverterAvailability) * 100, 2) AS InverterAvailability,
				DATE_FORMAT( sd.time, '%b-%Y') AS time_full
			FROM
				${table_data_report} sd
				LEFT JOIN device d ON d.id = sd.id_device 
			WHERE
				d.id_site = #{id_site}
				AND d.id_device_type = 3
				AND d.consumption_meter = 0
				AND (sd.time BETWEEN #{start_date} AND #{end_date})
				GROUP BY sd.time
		)t
		GROUP BY t.time_full
	</select>
	
	
	
	
	
	<select id="getDataEnergyMeterDailyReport" resultType="Map" >
		<if test="data_intervals == 1">
			  SELECT
				t.time_format,
				t.categories_time,
				t.hour_time,
				IFNULL(ROUND(SUM( t.nvmActivePower)), 0.001)  AS `power`,
				0 AS irradiance,
				0 AS energy
				
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT
							m.time,
							m.time_format,
							m.time_full,
							m.categories_time,
							m.hour_time,
							IFNULL(SUM(m.nvmActivePower), NULL) AS nvmActivePower
						FROM
							(
							SELECT
								dv.time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%Y-%m-%d %H:%i') AS time_format,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%m/%d/%Y %H:%i') AS time_full,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%m/%d/%Y %H:%i') AS categories_time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%H:00') AS hour_time,
								IFNULL(AVG(dv.nvmActivePower), 0) AS nvmActivePower 
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND d.id_device_type = 3
								AND d.consumption_meter = 0
								AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, time_format
							) m 
						GROUP BY
							m.time_format
						]]>
			      </foreach>
				) t 
			GROUP BY
				t.time_format
		</if>
		
		<if test="data_intervals == 2">
			  SELECT
				t.time_format,
				t.categories_time,
				t.hour_time,
				IFNULL(ROUND(SUM( t.nvmActivePower)), 0.001)  AS `power`,
				0 AS irradiance,
				0 AS energy
				
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT
							m.time,
							m.time_format,
							m.time_full,
							m.categories_time,
							m.hour_time,
							IFNULL(SUM(m.nvmActivePower), NULL) AS nvmActivePower
						FROM
							(
							SELECT
								dv.time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%Y-%m-%d %H:%i') AS time_format,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%m/%d/%Y %H:%i') AS time_full,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%m/%d/%Y %H:%i') AS categories_time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%H:00') AS hour_time,
								IFNULL(AVG(dv.nvmActivePower), 0) AS nvmActivePower 
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND d.id_device_type = 3
								AND d.consumption_meter = 0
								AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, time_format
							) m 
						GROUP BY
							m.time_format
						]]>
			      </foreach>
				) t 
			GROUP BY
				t.time_format
		</if>
		
		<if test="data_intervals == 3">
			  SELECT
				t.time_format,
				t.categories_time,
				t.hour_time,
				IFNULL(ROUND(SUM( t.nvmActivePower)), 0.001)  AS `power`,
				0 AS irradiance,
				0 AS energy
				
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT
							m.time,
							m.time_format,
							m.time_full,
							m.categories_time,
							m.hour_time,
							IFNULL(SUM(m.nvmActivePower), NULL) AS nvmActivePower
						FROM
							(
							SELECT
								dv.time,
								
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:00' ) AS time_format,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m/%d/%Y %H:00' ) AS time_full,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m/%d/%Y %H:00' ) AS categories_time,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%H:00' ) AS hour_time,
								IFNULL(AVG(dv.nvmActivePower), 0) AS nvmActivePower 
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND d.id_device_type = 3
								AND d.consumption_meter = 0
								AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, time_format
							) m 
						GROUP BY
							m.time_format
						]]>
			      </foreach>
				) t 
			GROUP BY
				t.time_format
		</if>
	</select>
	
	
	<select id="getDataEnergyInverterDailyReport" resultType="Map" >
		<if test="data_intervals == 1">
			SELECT
				t.time_format,
				t.categories_time,
				t.hour_time,
				IFNULL(ROUND(SUM( t.nvmActivePower)), 0.001)  AS `power`,
				0 AS irradiance,
				0 AS energy
				
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT
							m.time,
							m.time_format,
							m.time_full,
							m.categories_time,
							m.hour_time,
							IFNULL(SUM(m.nvmActivePower), NULL) AS nvmActivePower
						FROM
							(
							SELECT
								dv.time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%Y-%m-%d %H:%i') AS time_format,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%m/%d/%Y %H:%i') AS time_full,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%m/%d/%Y %H:%i') AS categories_time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%H:00') AS hour_time,
								
								IFNULL(AVG(dv.nvmActivePower), 0) AS nvmActivePower 
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND d.id_device_type = 1
								AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, time_format
							) m 
						GROUP BY
							m.time_format
						]]>
			      </foreach>
				) t 
			GROUP BY
				t.time_format
		</if>
		
		<if test="data_intervals == 2">
			SELECT
				t.time_format,
				t.categories_time,
				t.hour_time,
				IFNULL(ROUND(SUM( t.nvmActivePower)), 0.001)  AS `power`,
				0 AS irradiance,
				0 AS energy
				
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT
							m.time,
							m.time_format,
							m.time_full,
							m.categories_time,
							m.hour_time,
							IFNULL(SUM(m.nvmActivePower), NULL) AS nvmActivePower
						FROM
							(
							SELECT
								dv.time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%Y-%m-%d %H:%i') AS time_format,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%m/%d/%Y %H:%i') AS time_full,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%m/%d/%Y %H:%i') AS categories_time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%H:00') AS hour_time,
								
								IFNULL(AVG(dv.nvmActivePower), 0) AS nvmActivePower 
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND d.id_device_type = 1
								AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, time_format
							) m 
						GROUP BY
							m.time_format
						]]>
			      </foreach>
				) t 
			GROUP BY
				t.time_format
		</if>
		
		<if test="data_intervals == 3">
			  SELECT
				t.time_format,
				t.categories_time,
				t.hour_time,
				IFNULL(ROUND(SUM( t.nvmActivePower)), 0.001)  AS `power`,
				0 AS irradiance,
				0 AS energy
				
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT
							m.time,
							m.time_format,
							m.time_full,
							m.categories_time,
							m.hour_time,
							IFNULL(SUM(m.nvmActivePower), NULL) AS nvmActivePower
						FROM
							(
							SELECT
								dv.time,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:00' ) AS time_format,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m/%d/%Y %H:00' ) AS time_full,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m/%d/%Y %H:00' ) AS categories_time,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%H:00' ) AS hour_time,
								IFNULL(AVG(dv.nvmActivePower), 0) AS nvmActivePower 
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND d.id_device_type = 1
								AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, time_format
							) m 
						GROUP BY
							m.time_format
						]]>
			      </foreach>
				) t 
			GROUP BY
				t.time_format
		</if>
		
	</select>
	
	<select id="getDataEnergyCustomReport" resultType="Map" >
			SELECT
				s.id,
				s.id AS id_site,
				s.`name`,
				DATE_FORMAT( sdr.time, '%m' ) AS month,
				DATE_FORMAT( sdr.time, '%Y' ) AS year,
				<choose>
					<when test="data_intervals == 4">
						DATE_FORMAT( sdr.time, '%m/%d/%Y' )
					</when>
					<when test="data_intervals == 6">
						DATE_FORMAT( sdr.time , "%m/%Y" )
					</when>
					<when test="data_intervals == 7">
						DATE_FORMAT( sdr.time , "%Y" )
					</when>
					<otherwise>
						DATE_FORMAT( sdr.time , "%m/%Y" )
					</otherwise>
				</choose>
				AS categories_time,
				DATE_FORMAT( sdr.time, '%m/%d/%Y' ) AS time_full,
				DATE_FORMAT( sdr.time, '%Y-%m-%d' ) AS time_format,
				
				IF( (SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0))) > 0, (ROUND(SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)), 1)), ROUND(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)), 1) ) AS actual,
				IFNULL(SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)), 0.001) AS meterEnergy,
				IFNULL(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)), 0.001) AS inverterEnergy
				
			FROM
				${table_data_report} sdr 
				LEFT JOIN device d ON d.id = sdr.id_device
				LEFT JOIN site s ON s.id = d.id_site
				LEFT JOIN time_zone t ON t.id = s.id_time_zone
				
			WHERE
				s.`status` = 1
				AND d.`status` = 1
				AND s.is_delete = 0
				AND d.is_delete = 0
				AND s.id = #{id_site}
				AND (sdr.time BETWEEN #{date_from} AND #{date_to})
				
			GROUP BY 
				s.id,
				<choose>
					<when test="data_intervals == 4">
						DATE_FORMAT( sdr.time , "%Y-%m-%d")
					</when>
					<when test="data_intervals == 6">
						DATE_FORMAT( sdr.time , "%Y-%m")
					</when>
					<when test="data_intervals == 7">
						DATE_FORMAT( sdr.time , "%Y")
					</when>
					<otherwise>
						DATE_FORMAT( sdr.time , "%Y-%m")
					</otherwise>
				</choose>
	</select>
	
	<select id="getOperationPerformanceReport" resultType="Map">
		SELECT
			time_full,
			ROUND(actualEnergy, 0) AS actualEnergy,
			ROUND(modeledEnergy, 0) AS modeledEnergy,
			ROUND(expectedEnergy, 0) AS expectedEnergy,
			ROUND(actualPOA, 1) AS actualPOA,
			ROUND(modeledPOA, 1) AS modeledPOA,
			ROUND(IF(actualEnergy IS NOT NULL AND actualPOA IS NOT NULL AND dc_capacity IS NOT NULL, actualEnergy / (actualPOA * dc_capacity) * 100, NULL), 1) AS actualPerformanceRatio,
			ROUND(IF(modeledEnergy IS NOT NULL AND modeledPOA IS NOT NULL AND dc_capacity IS NOT NULL, modeledEnergy / (modeledPOA * dc_capacity) * 100, NULL), 1) AS modeledPerformanceRatio,
			ROUND(IF(actualEnergy IS NOT NULL AND modeledEnergy IS NOT NULL, actualEnergy / modeledEnergy * 100, NULL), 1) AS energyIndex,
			ROUND(IF(actualPOA IS NOT NULL AND modeledPOA IS NOT NULL, actualPOA / modeledPOA * 100, NULL), 1) AS weatherIndex,
			ROUND(IF(actualEnergy IS NOT NULL AND modeledEnergy IS NOT NULL AND actualPOA IS NOT NULL AND modeledPOA IS NOT NULL, (actualEnergy / modeledEnergy) / (actualPOA / modeledPOA) * 100, NULL), 1) AS weatherAdjustedIndex,
			ROUND(InverterAvailability * 100, 1) AS inverterAvailability
		FROM (
			SELECT
				sdr.time_full,
				sdr.dc_capacity,
				sdr.InverterAvailability AS InverterAvailability,
				CASE
					WHEN sdr.`month` = "Jan" THEN ee.jan
					WHEN sdr.`month` = "Feb" THEN ee.feb
					WHEN sdr.`month` = "Mar" THEN ee.mar
					WHEN sdr.`month` = "Apr" THEN ee.apr
					WHEN sdr.`month` = "May" THEN ee.may
					WHEN sdr.`month` = "Jun" THEN ee.jun
					WHEN sdr.`month` = "Jul" THEN ee.jul
					WHEN sdr.`month` = "Aug" THEN ee.aug
					WHEN sdr.`month` = "Sep" THEN ee.sep
					WHEN sdr.`month` = "Oct" THEN ee.oct
					WHEN sdr.`month` = "Nov" THEN ee.nov
					WHEN sdr.`month` = "Dec" THEN ee.`dec`
				END AS modeledEnergy,
				CASE
					WHEN sdr.`month` = "Jan" THEN ie.jan
					WHEN sdr.`month` = "Feb" THEN ie.feb
					WHEN sdr.`month` = "Mar" THEN ie.mar
					WHEN sdr.`month` = "Apr" THEN ie.apr
					WHEN sdr.`month` = "May" THEN ie.may
					WHEN sdr.`month` = "Jun" THEN ie.jun
					WHEN sdr.`month` = "Jul" THEN ie.jul
					WHEN sdr.`month` = "Aug" THEN ie.aug
					WHEN sdr.`month` = "Sep" THEN ie.sep
					WHEN sdr.`month` = "Oct" THEN ie.oct
					WHEN sdr.`month` = "Nov" THEN ie.nov
					WHEN sdr.`month` = "Dec" THEN ie.`dec`
				END AS modeledPOA,
				<choose>
					<when test="enable_virtual_device.booleanValue()">
						vir.actualEnergy AS actualEnergy,
						vir.expectedPower * 24 * DAY(LAST_DAY(STR_TO_DATE(vir.time_full, "%b-%y"))) AS expectedEnergy,
						vir.actualPOA AS actualPOA
					</when>
					<otherwise>
						sdr.actualEnergy AS actualEnergy,
						sdr.expectedPower * 24 * DAY(LAST_DAY(STR_TO_DATE(sdr.time_full, "%b-%y"))) AS expectedEnergy,
						sdr.actualPOA AS actualPOA
					</otherwise>
				</choose>
			FROM
				(
					SELECT
						DATE_FORMAT(sdr.time, "%b-%y") AS time_full,
						DATE_FORMAT(sdr.time, "%b") AS `month`,
						DATE_FORMAT(sdr.time, "%Y") AS `year`,
						IF(
							SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)) > 0,
							ROUND(SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)), 1),
							ROUND(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)), 1)
						) AS actualEnergy,
						CASE
							WHEN s.pv_model = 1 THEN
								AVG(IF(d.id_device_type = 4,
									IF(
										IFNULL(s.dc_capacity * (sdr.POAAVG / s.global_solar_irradiance_at_stc) * (1 - (IFNULL(s.pv_module_temperature_coeff, -0.43)/100) * (s.stc_temperature - sdr.TCellAVG)) * (1 - IFNULL(s.system_loss, 9)/100), 0) * IFNULL(s.inverter_efficiency, 96)/100 <![CDATA[ < ]]> s.ac_capacity,
										s.dc_capacity * (sdr.POAAVG / s.global_solar_irradiance_at_stc) * (1 - (IFNULL(s.pv_module_temperature_coeff, -0.43)/100) * (s.stc_temperature - sdr.TCellAVG)) * (1 - IFNULL(s.system_loss, 9)/100) * IFNULL(s.inverter_efficiency, 96)/100,
										s.ac_capacity
									),
									NULL
								))
							WHEN s.pv_model = 2 THEN
								AVG(IF(d.id_device_type = 4,
									IF(
										IFNULL( s.dc_capacity * (ROUND(sdr.POAAVG,0) / s.global_solar_irradiance_at_stc) * (1 - ROUND((1 + (IFNULL(s.pv_module_temperature_coeff, -0.43)/100)) * ((sdr.TCellAVG - s.stc_temperature)/100), 4)) * (ROUND(POW(1 - (IFNULL(s.annual_pv_module_degradation, 0.5)/100), YEAR(CURRENT_TIMESTAMP) - IFNULL(YEAR(s.commissioning), YEAR(s.built_since))) * 100, 2) / 100) * (1 - (IFNULL(s.soiling, 5)/100)) * (1 - (IFNULL(s.cable_losses, 1)/100)) * (1 - (IFNULL(s.transformer_losses, 1.5)/100)) * (1 - (IFNULL(s.other_losses, 1.5)/100)) * (IFNULL(s.inverter_efficiency, 98.5)/100), 0) <![CDATA[ < ]]> s.ac_capacity,
										IFNULL( s.dc_capacity * (ROUND(sdr.POAAVG,0) / s.global_solar_irradiance_at_stc) * (1 - ROUND((1 + (IFNULL(s.pv_module_temperature_coeff, -0.43)/100)) * ((sdr.TCellAVG - s.stc_temperature)/100), 4)) * (ROUND(POW(1 - (IFNULL(s.annual_pv_module_degradation, 0.5)/100), YEAR(CURRENT_TIMESTAMP) - IFNULL(YEAR(s.commissioning), YEAR(s.built_since))) * 100, 2) / 100) * (1 - (IFNULL(s.soiling, 5)/100)) * (1 - (IFNULL(s.cable_losses, 1)/100)) * (1 - (IFNULL(s.transformer_losses, 1.5)/100)) * (1 - (IFNULL(s.other_losses, 1.5)/100)) * (IFNULL(s.inverter_efficiency, 98.5)/100), 0),
										s.ac_capacity
									),
									NULL
								))
							ELSE
								AVG(IF(d.id_device_type = 4,
									IF(
										s.t_avg IS NULL OR NOT (sdr.POAAVG >= s.min_irradiance_limit AND (IF(sdr.PowerTodayAVG > (s.ac_capacity * IFNULL(s.clip, 99)/100), 1, 0) = 0)),
										NULL,
										s.dc_capacity * (sdr.POAAVG / s.global_solar_irradiance_at_stc) * (1 - IFNULL(s.pv_module_temperature_coeff, -0.37)/100 * (s.t_avg - (sdr.TCellAVG + sdr.POAAVG/s.global_solar_irradiance_at_stc * 3))) * IFNULL(s.inverter_efficiency, 100)/100
									),
									NULL
								))
						END AS expectedPower,
						AVG(IF(d.id_device_type = 4 AND d.reverse_poa = 0, sdr.POAAVG, NULL)) AS actualPOA,
						SUM(ia.InverterAvailability) / DATE_FORMAT(LAST_DAY(sdr.time),'%d') AS InverterAvailability,
						s.dc_capacity
					FROM
						${table_data_report} sdr
						LEFT JOIN device d ON d.id = sdr.id_device
						LEFT JOIN site s ON s.id = d.id_site
						LEFT JOIN (
							SELECT
								sdr.time,
								AVG(sdr.InverterAvailability) AS InverterAvailability,
								d.id
							FROM
								${table_data_report} sdr
								LEFT JOIN device d ON d.id = sdr.id_device
							WHERE
								d.id_site = #{id_site}
								AND d.status = 1
								AND d.is_delete = 0
								AND d.id_device_type = 1
								AND sdr.time BETWEEN #{start_date} AND #{end_date}
							GROUP BY
								sdr.time
						) ia ON ia.time = sdr.time AND ia.id = d.id
					WHERE
						d.id_site = #{id_site}
						AND d.status = 1
						AND d.is_delete = 0
						AND s.status = 1
						AND s.is_delete = 0
						AND sdr.time BETWEEN #{start_date} AND #{end_date}
					GROUP BY
						time_full
				) sdr
				LEFT JOIN (
					SELECT
						id_site, `year`, jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, `dec`
					FROM
						energy_expectations
					WHERE
						id_site = #{id_site}
						AND `year` BETWEEN DATE_FORMAT(#{start_date}, "%Y") AND DATE_FORMAT(#{end_date}, "%Y")
				) ee ON ee.`year` = sdr.`year`
				LEFT JOIN (
					SELECT
						id_site, jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, `dec`
					FROM
						irradiance_expectations
					WHERE
						id_site = #{id_site}
				) ie ON ie.id_site = ee.id_site
				<if test="enable_virtual_device.booleanValue()">
					LEFT JOIN (
						SELECT
							DATE_FORMAT(CONVERT_TZ(vir.time, "+00:00", tz.`offset`), "%b-%y") AS time_full,
							SUM(vir.nvmActiveEnergy) AS actualEnergy,
							AVG(vir.expected_power_ac) AS expectedPower,
							AVG(vir.nvm_irradiance) AS actualPOA
						FROM
							${table_data_virtual} vir
							LEFT JOIN device d ON d.id = vir.id_device
							LEFT JOIN site s ON s.id = d.id_site
							LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
						WHERE
							d.id_site = #{id_site}
							AND d.status = 1
							AND d.is_delete = 0
							AND s.status = 1
							AND s.is_delete = 0
							AND vir.time BETWEEN CONVERT_TZ(#{start_date}, tz.`offset`, "+00:00") AND CONVERT_TZ(#{end_date}, tz.`offset`, "+00:00")
						GROUP BY
							time_full
					) vir ON vir.time_full = sdr.time_full
				</if>
		) m
	</select>
	
	<select id="getMonthlyPerformanceReport" resultType="Map">
		SELECT
			time_full,
			ROUND(actualEnergy, 0) AS actualEnergy,
			ROUND(expectedEnergy, 0) AS expectedEnergy,
			ROUND(modeledEnergy, 0) AS modeledEnergy,
			ROUND(IF(actualEnergy IS NOT NULL AND expectedEnergy IS NOT NULL, actualEnergy / expectedEnergy * 100, NULL), 1) AS expectedGenerationIndex,
			ROUND(IF(actualEnergy IS NOT NULL AND modeledEnergy IS NOT NULL, actualEnergy / modeledEnergy * 100, NULL), 1) AS modeledGenerationIndex
		FROM (
			SELECT
				sdr.time_full,
				sdr.actualEnergy,
				sdr.expectedPower * 24 AS expectedEnergy,
				CASE
					WHEN sdr.`month` = "Jan" THEN ee.jan
					WHEN sdr.`month` = "Feb" THEN ee.feb
					WHEN sdr.`month` = "Mar" THEN ee.mar
					WHEN sdr.`month` = "Apr" THEN ee.apr
					WHEN sdr.`month` = "May" THEN ee.may
					WHEN sdr.`month` = "Jun" THEN ee.jun
					WHEN sdr.`month` = "Jul" THEN ee.jul
					WHEN sdr.`month` = "Aug" THEN ee.aug
					WHEN sdr.`month` = "Sep" THEN ee.sep
					WHEN sdr.`month` = "Oct" THEN ee.oct
					WHEN sdr.`month` = "Nov" THEN ee.nov
					WHEN sdr.`month` = "Dec" THEN ee.`dec`
				END / DAY(LAST_DAY(STR_TO_DATE(sdr.time_full, "%m/%d/%Y"))) AS modeledEnergy
			FROM
				(
					<choose>
						<when test="enable_virtual_device.booleanValue()">
							SELECT
								DATE_FORMAT(CONVERT_TZ(vir.time, "+00:00", tz.`offset`), "%m/%d/%Y") AS time_full,
								DATE_FORMAT(CONVERT_TZ(vir.time, "+00:00", tz.`offset`), "%b") AS `month`,
								DATE_FORMAT(CONVERT_TZ(vir.time, "+00:00", tz.`offset`), "%Y") AS `year`,
								SUM(vir.nvmActiveEnergy) AS actualEnergy,
								AVG(vir.expected_power_ac) AS expectedPower
							FROM
								${table_data_virtual} vir
								LEFT JOIN device d ON d.id = vir.id_device
								LEFT JOIN site s ON s.id = d.id_site
								LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
							WHERE
								d.id_site = #{id_site}
								AND d.status = 1
								AND d.is_delete = 0
								AND s.status = 1
								AND s.is_delete = 0
								AND vir.time BETWEEN CONVERT_TZ(#{start_date}, tz.`offset`, "+00:00") AND CONVERT_TZ(#{end_date}, tz.`offset`, "+00:00")
							GROUP BY
								time_full
						</when>
						<otherwise>
							SELECT
								DATE_FORMAT(sdr.time, "%m/%d/%Y") AS time_full,
								DATE_FORMAT(sdr.time, "%b") AS `month`,
								DATE_FORMAT(sdr.time, "%Y") AS `year`,
								IF(
									SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)) > 0,
									ROUND(SUM(IF(d.id_device_type = 3 AND d.consumption_meter = 0, sdr.ActualGeneration, 0)), 1),
									ROUND(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)), 1)
								) AS actualEnergy,
								CASE
									WHEN s.pv_model = 1 THEN
										AVG(IF(d.id_device_type = 4,
											IF(
												IFNULL(s.dc_capacity * (sdr.POAAVG / s.global_solar_irradiance_at_stc) * (1 - (IFNULL(s.pv_module_temperature_coeff, -0.43)/100) * (s.stc_temperature - sdr.TCellAVG)) * (1 - IFNULL(s.system_loss, 9)/100), 0) * IFNULL(s.inverter_efficiency, 96)/100 <![CDATA[ < ]]> s.ac_capacity,
												s.dc_capacity * (sdr.POAAVG / s.global_solar_irradiance_at_stc) * (1 - (IFNULL(s.pv_module_temperature_coeff, -0.43)/100) * (s.stc_temperature - sdr.TCellAVG)) * (1 - IFNULL(s.system_loss, 9)/100) * IFNULL(s.inverter_efficiency, 96)/100,
												s.ac_capacity
											),
											NULL
										))
									WHEN s.pv_model = 2 THEN
										AVG(IF(d.id_device_type = 4,
											IF(
												IFNULL( s.dc_capacity * (ROUND(sdr.POAAVG,0) / s.global_solar_irradiance_at_stc) * (1 - ROUND((1 + (IFNULL(s.pv_module_temperature_coeff, -0.43)/100)) * ((sdr.TCellAVG - s.stc_temperature)/100), 4)) * (ROUND(POW(1 - (IFNULL(s.annual_pv_module_degradation, 0.5)/100), YEAR(CURRENT_TIMESTAMP) - IFNULL(YEAR(s.commissioning), YEAR(s.built_since))) * 100, 2) / 100) * (1 - (IFNULL(s.soiling, 5)/100)) * (1 - (IFNULL(s.cable_losses, 1)/100)) * (1 - (IFNULL(s.transformer_losses, 1.5)/100)) * (1 - (IFNULL(s.other_losses, 1.5)/100)) * (IFNULL(s.inverter_efficiency, 98.5)/100), 0) <![CDATA[ < ]]> s.ac_capacity,
												IFNULL( s.dc_capacity * (ROUND(sdr.POAAVG,0) / s.global_solar_irradiance_at_stc) * (1 - ROUND((1 + (IFNULL(s.pv_module_temperature_coeff, -0.43)/100)) * ((sdr.TCellAVG - s.stc_temperature)/100), 4)) * (ROUND(POW(1 - (IFNULL(s.annual_pv_module_degradation, 0.5)/100), YEAR(CURRENT_TIMESTAMP) - IFNULL(YEAR(s.commissioning), YEAR(s.built_since))) * 100, 2) / 100) * (1 - (IFNULL(s.soiling, 5)/100)) * (1 - (IFNULL(s.cable_losses, 1)/100)) * (1 - (IFNULL(s.transformer_losses, 1.5)/100)) * (1 - (IFNULL(s.other_losses, 1.5)/100)) * (IFNULL(s.inverter_efficiency, 98.5)/100), 0),
												s.ac_capacity
											),
											NULL
										))
									ELSE
										AVG(IF(d.id_device_type = 4,
											IF(
												s.t_avg IS NULL OR NOT (sdr.POAAVG >= s.min_irradiance_limit AND (IF(sdr.PowerTodayAVG > (s.ac_capacity * IFNULL(s.clip, 99)/100), 1, 0) = 0)),
												NULL,
												s.dc_capacity * (sdr.POAAVG / s.global_solar_irradiance_at_stc) * (1 - IFNULL(s.pv_module_temperature_coeff, -0.37)/100 * (s.t_avg - (sdr.TCellAVG + sdr.POAAVG/s.global_solar_irradiance_at_stc * 3))) * IFNULL(s.inverter_efficiency, 100)/100
											),
											NULL
										))
								END AS expectedPower
							FROM
								${table_data_report} sdr
								LEFT JOIN device d ON d.id = sdr.id_device
								LEFT JOIN site s ON s.id = d.id_site
							WHERE
								d.id_site = #{id_site}
								AND d.status = 1
								AND d.is_delete = 0
								AND s.status = 1
								AND s.is_delete = 0
								AND sdr.time BETWEEN #{start_date} AND #{end_date}
							GROUP BY
								time_full
						</otherwise>
					</choose>
				) sdr
				LEFT JOIN (
					SELECT
						id_site, `year`, jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, `dec`
					FROM
						energy_expectations
					WHERE
						id_site = #{id_site}
						AND `year` BETWEEN DATE_FORMAT(#{start_date}, "%Y") AND DATE_FORMAT(#{end_date}, "%Y")
				) ee ON ee.`year` = sdr.`year`
		) m
	</select>
	
	<select id="getEstimatedLossByEventReport" resultType="Map">
		SELECT
			event,
			devicename,
			startTime,
			endTime,
			duration,
			ROUND(duration * modeledEnergy * ratio / DAY(LAST_DAY(#{start_date})), 0) AS estimatedLoss
		FROM (
			SELECT
				er.message AS event,
				d.devicename,
				IFNULL(d.rating_ac_power, 0) / s.ac_capacity AS ratio,
				DATE_FORMAT(CONVERT_TZ(al.start_date, "+00:00", tz.`offset`), "%m/%d/%Y %h:%i %p") AS startTime,
				DATE_FORMAT(CONVERT_TZ(al.end_date, "+00:00", tz.`offset`), "%m/%d/%Y %h:%i %p") AS endTime,
				DATEDIFF(IFNULL(CONVERT_TZ(al.end_date, "+00:00", tz.`offset`), CONVERT_TZ(UTC_TIMESTAMP(), "+00:00", tz.`offset`)), CONVERT_TZ(al.start_date, "+00:00", tz.`offset`)) AS duration,
				ROUND(
					CASE
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Jan" THEN ee.jan
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Feb" THEN ee.feb
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Mar" THEN ee.mar
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Apr" THEN ee.apr
						WHEN DATE_FORMAT(#{start_date}, "%b") = "May" THEN ee.may
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Jun" THEN ee.jun
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Jul" THEN ee.jul
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Aug" THEN ee.aug
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Sep" THEN ee.sep
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Oct" THEN ee.oct
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Nov" THEN ee.nov
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Dec" THEN ee.`dec`
					END,
					0
				) AS modeledEnergy
			FROM
				device d
				LEFT JOIN alert al ON al.id_device = d.id
				LEFT JOIN error er ON er.id = al.id_error
				LEFT JOIN site s ON s.id = d.id_site
				LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
				LEFT JOIN energy_expectations ee ON ee.id_site = s.id AND ee.`year` = DATE_FORMAT(#{start_date}, "%Y")
			WHERE
				d.id_site = #{id_site}
				AND d.id_device_type = 1
				AND d.`status` = 1
				AND d.is_delete = 0
				AND s.`status` = 1
				AND s.is_delete = 0
				AND er.`status` = 1
				AND er.is_delete = 0
				AND er.error_code = "1000"
				AND al.is_delete = 0
				AND al.start_date IS NOT NULL
				AND al.start_date BETWEEN CONVERT_TZ(#{start_date}, tz.`offset`, "+00:00") AND CONVERT_TZ(#{end_date}, tz.`offset`, "+00:00")
		) m
	</select>
	
	<select id="getDataIrradiance" resultType="Map" >
		<if test="data_intervals == 1">
			SELECT
				t.time,
				t.time_format,
				IFNULL(ROUND(SUM( t.irradiance)), 0.001)  AS `irradiance`,
				
				t.time_full,
				t.categories_time,
				t.hour_time
				
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT
							m.time,
							m.time_format,
							m.time_full,
							IFNULL(SUM(m.nvm_irradiance), NULL) AS irradiance,
							m.categories_time,
							m.hour_time
							
						FROM
							(
							SELECT
								dv.time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%Y-%m-%d %H:%i') AS time_format,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%m/%d/%Y %H:%i') AS time_full,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%m/%d/%Y %H:%i') AS categories_time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%H:00') AS hour_time,
								IFNULL(AVG(dv.nvm_irradiance), 0) AS nvm_irradiance 
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND d.id_device_type IN(4,6)
								AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, time_format
							) m 
						GROUP BY
							m.time_format
						]]>
			      </foreach>
				) t 
			GROUP BY
				t.time_format
		</if>
		<if test="data_intervals == 2">
			SELECT
				t.time,
				t.time_format,
				IFNULL(ROUND(SUM( t.irradiance)), 0.001)  AS `irradiance`,
				t.time_full,
				t.categories_time,
				t.hour_time
				
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT
							m.time,
							m.time_format,
							m.time_full,
							IFNULL(SUM(m.nvm_irradiance), NULL) AS irradiance,
							m.categories_time,
							m.hour_time
							
						FROM
							(
							SELECT
								dv.time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%Y-%m-%d %H:%i') AS time_format,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%m/%d/%Y %H:%i') AS time_full,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%m/%d/%Y %H:%i') AS categories_time,
								FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 900)*900), '%H:00') AS hour_time,
								IFNULL(AVG(dv.nvm_irradiance), 0) AS nvm_irradiance 
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND d.id_device_type IN(4,6)
								AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, time_format
							) m 
						GROUP BY
							m.time_format
						]]>
			      </foreach>
				) t 
			GROUP BY
				t.time_format
		</if>
		<if test="data_intervals == 3">
			SELECT
				t.time,
				t.time_format,
				IFNULL(ROUND(SUM( t.irradiance)), 0.001)  AS `irradiance`,
				t.time_full,
				t.categories_time,
				t.hour_time
				
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT
							m.time,
							m.time_format,
							m.time_full,
							IFNULL(SUM(m.nvm_irradiance), NULL) AS irradiance,
							m.categories_time,
							m.hour_time
							
						FROM
							(
							SELECT
								dv.time,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:%i' ) AS time_format,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m/%d/%Y %H:00' ) AS time_full,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m/%d/%Y %H:00' ) AS categories_time,
								DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%H:00' ) AS hour_time,
								IFNULL(AVG(dv.nvm_irradiance), 0) AS nvm_irradiance 
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND d.id_device_type IN(4,6)
								AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, time_format
							) m 
						GROUP BY
							m.time_format
						]]>
			      </foreach>
				) t 
			GROUP BY
				t.time_format
		</if>
	</select>
	
	<select id="getListDeviceTypeIrradiance" resultType="Map">
		SELECT
			d.id,
			d.devicename,
			d.datatablename,
			d.id_site
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
		WHERE
			dt.id IN(4,6)
			AND d.id_site = #{id_site}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getExpectationsRow" resultType="com.nwm.api.entities.EnergyExpectationsEntity">
		SELECT
			* 
		FROM
			energy_expectations ee 
		WHERE
			ee.id_site = #{id_site}
			AND `year` = DATE_FORMAT(#{start_date},"%Y")
  	</select>
	
	
	<insert id="insertReportSiteMap">
		INSERT INTO `report_site_map`(
			id_report,
			id_site
		)VALUES
			<foreach item="item" collection="dataSite" separator=",">
				(#{id}, #{item.id})
			</foreach>
	</insert>
	
	
	
	<delete id = "deleteReportSiteMap" parameterType = "com.nwm.api.entities.ReportsEntity">
		DELETE FROM `report_site_map`
		WHERE id_report = #{id};
	</delete>
  	
	
</mapper>