<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ScadaCharting">
	
	<select id="getSiteDetail" resultType="com.nwm.api.entities.ScadaChartingEntity" >
		SELECT
			s.id,
			s.data_send_time,
			s.commissioning,
			tz.value AS timezone_value
		FROM
			site s
			LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
		WHERE
			SHA1(s.id) = #{hash_id_site}
			AND s.status = 1
			AND s.is_delete = 0
	</select>
	
	<select id="getHiddenDataListByDevice" resultType="Map">
		SELECT
			date_from,
			date_to
		FROM
			hidden_data
		WHERE
			id_device = #{id}
			AND status = 1
			AND is_delete = 0
	</select>
	
	<select id="getFilterParamsByDevice" resultType="Map">
		SELECT
			id_device,
			id_device_parameter,
			min_value,
			max_value
		FROM
			device_parameter_filter
		WHERE
			id_device = #{id}
	</select>
	
	<select id="getListFilter" resultType="com.nwm.api.entities.ScadaEmployeeChartFilterEntity">
		SELECT
			id,
			id_employee,
			id_site,
			params,
			DATE_FORMAT(created_date, "%m/%d/%Y %H:%i:%s") AS created_date,
			name,
			is_favorite
		FROM
			scada_employee_chart_filter
		WHERE
			id_employee = #{id_employee}
			AND SHA1(id_site) = #{hash_id_site}
		ORDER BY id DESC
	</select>
	
	<insert id="saveFilter" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO scada_employee_chart_filter (
			`id_employee`,
			`id_site`,
			`params`,
			`created_date`,
			`name`,
			`is_favorite`
		)
		SELECT
			#{id_employee} AS id_employee,
			id AS id_site,
			#{params} AS params,
			#{created_date} AS created_date,
			#{name} AS name,
			#{is_favorite} AS is_favorite
		FROM
			site
		WHERE
			SHA1(id) = #{hash_id_site};
		
		<selectKey keyProperty="id" resultType="int">
	        SELECT 
	        LAST_INSERT_ID() as id
        </selectKey>
	</insert>
	
	<select id="getFiltersCount" resultType="int">
    	SELECT
    		COUNT(*)
		FROM
			scada_employee_chart_filter
		WHERE
			id_employee = #{id_employee}
			AND SHA1(id_site) = #{hash_id_site}
			AND is_favorite = #{is_favorite}
  	</select>
  	
  	<delete id="deleteFilter">
  		DELETE FROM
  			scada_employee_chart_filter
	 	WHERE
	 		id_employee = #{id_employee}
	 		AND SHA1(id_site) = #{hash_id_site}
	 		AND is_favorite = #{is_favorite}
	 	ORDER BY id ASC
	 	LIMIT 1
	</delete>
	
</mapper>