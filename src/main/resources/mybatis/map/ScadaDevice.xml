<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ScadaDevice">
	
	<select id="getListDeviceBySite" resultType="com.nwm.api.entities.ScadaDeviceEntity" >
		SELECT
			id,
			devicename AS name,
			id_site,
			serial_number,
			modbusdevicenumber
		FROM
			device d
		WHERE
			id_site = #{id_site}
			AND id_device_type = 1
	</select>
	
	<select id="getDeviceDetail" resultType="Map" >
		SELECT
			d.id,
			d.datatablename,
			tz.value AS time_zone_value
		FROM
			device d
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
		WHERE
			d.modbusdevicenumber = #{modbusdevicenumber}
			AND d.id_site = #{id_site}
			AND d.id_device_type = 1
			AND d.status = 1
			AND d.is_delete = 0
			AND s.status = 1
			AND s.is_delete = 0
	</select>
	
	<select id="getChartData" resultType="com.nwm.api.entities.ScadaDeviceChartDataEntity">
		SELECT
			dv.nvmActivePower AS active_power,
			FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%Y-%m-%d %H:%i') AS full_time,
			FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, '+00:00', t.`offset` )) DIV 300)*300), '%H:%i %d. %b') AS category_time
		FROM
			${datatablename} dv
			LEFT JOIN device d ON d.id = dv.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.id = #{id}
			AND CONVERT_TZ(dv.time, '+00:00', t.`offset`) BETWEEN #{start_datetime} AND #{end_datetime}
		GROUP BY
			full_time
	</select>
	
</mapper>